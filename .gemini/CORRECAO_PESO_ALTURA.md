# âœ… CORREÃ‡ÃƒO: Erro ao Salvar Dados no Supabase

## ğŸ› Erro Encontrado

```
PGRST204: Could not find the 'peso_altura' column of 'ayra_cadastro' in the schema cache
```

---

## ğŸ” Causa do Problema

### âŒ O Que Estava Errado:

O cÃ³digo tentava salvar uma coluna `peso_altura` que **nÃ£o existe** na tabela do Supabase.

**Schema Real da Tabela:**
```sql
create table public.ayra_cadastro (
  id bigint generated by default as identity not null,
  nome text null,
  email text null,
  plano text null,
  created_at timestamp without time zone null,
  updated_at timestamp without time zone null,
  telefone text null,
  idade numeric null,
  peso numeric null,          -- âœ… Existe
  altura numeric null,        -- âœ… Existe
  -- peso_altura text null,   -- âŒ NÃƒO EXISTE!
  problemas_de_saude text null,
  restricoes text null,
  objetivo text null,
  dificuldade text null,
  tem_nutri_ou_dieta text null,
  info_extra text null,
  cadastro_completo text null,
  id_usuario text null,
  constraint ayra_cadastro_pkey primary key (id)
);
```

### âŒ CÃ³digo Antigo:

**`src/lib/supabaseAuth.ts`:**
```typescript
export interface AyraUser {
    id: number;
    nome: string;
    email: string;
    plano: string | null;
    telefone?: string;
    idade?: number;
    peso_altura?: string;  // âŒ Coluna nÃ£o existe!
    // ...
}

export async function updateUserData(userId: number, data: Partial<AyraUser>) {
    const { error } = await supabase
        .from('ayra_cadastro')
        .update({
            telefone: data.telefone,
            idade: data.idade,
            peso_altura: data.peso_altura,  // âŒ ERRO!
            // ...
        })
        .eq('id', userId);
}
```

**`src/pages/AnamnesePage.tsx`:**
```typescript
const result = await updateUserData(user.id, {
    nome: formData.nome,
    telefone: formData.telefone,
    idade: parseInt(formData.idade),
    peso_altura: `${formData.peso}kg / ${formData.altura}m`,  // âŒ ERRO!
    // ...
});
```

---

## âœ… SoluÃ§Ã£o Implementada

### 1. Atualizar Interface `AyraUser`

**Arquivo:** `src/lib/supabaseAuth.ts`

**Antes:**
```typescript
export interface AyraUser {
    id: number;
    nome: string;
    email: string;
    plano: string | null;
    telefone?: string;
    idade?: number;
    peso_altura?: string;  // âŒ Errado
    problemas_de_saude?: string;
    restricoes?: string;
    objetivo?: string;
    dificuldade?: string;
    tem_nutri_ou_dieta?: string;
    info_extra?: string;
}
```

**Depois:**
```typescript
export interface AyraUser {
    id: number;
    nome: string;
    email: string;
    plano: string | null;
    telefone?: string;
    idade?: number;
    peso?: number;         // âœ… Correto
    altura?: number;       // âœ… Correto
    problemas_de_saude?: string;
    restricoes?: string;
    objetivo?: string;
    dificuldade?: string;
    tem_nutri_ou_dieta?: string;
    info_extra?: string;
}
```

### 2. Atualizar FunÃ§Ã£o `updateUserData`

**Antes:**
```typescript
export async function updateUserData(userId: number, data: Partial<AyraUser>) {
    const { error } = await supabase
        .from('ayra_cadastro')
        .update({
            telefone: data.telefone,
            idade: data.idade,
            peso_altura: data.peso_altura,  // âŒ Coluna nÃ£o existe
            problemas_de_saude: data.problemas_de_saude,
            restricoes: data.restricoes,
            objetivo: data.objetivo,
            dificuldade: data.dificuldade,
            tem_nutri_ou_dieta: data.tem_nutri_ou_dieta,
            info_extra: data.info_extra,
            updated_at: new Date().toISOString()
        })
        .eq('id', userId);
}
```

**Depois:**
```typescript
export async function updateUserData(userId: number, data: Partial<AyraUser>) {
    const { error } = await supabase
        .from('ayra_cadastro')
        .update({
            nome: data.nome,                // âœ… Adicionado
            telefone: data.telefone,
            idade: data.idade,
            peso: data.peso,                // âœ… Correto
            altura: data.altura,            // âœ… Correto
            problemas_de_saude: data.problemas_de_saude,
            restricoes: data.restricoes,
            objetivo: data.objetivo,
            dificuldade: data.dificuldade,
            tem_nutri_ou_dieta: data.tem_nutri_ou_dieta,
            info_extra: data.info_extra,
            updated_at: new Date().toISOString()
        })
        .eq('id', userId);
}
```

### 3. Atualizar Chamada em `AnamnesePage`

**Antes:**
```typescript
const result = await updateUserData(user.id, {
    nome: formData.nome,
    telefone: formData.telefone,
    idade: formData.idade ? parseInt(formData.idade) : undefined,
    peso_altura: `${formData.peso}kg / ${formData.altura}m`,  // âŒ Errado
    problemas_de_saude: formData.problemas_de_saude,
    restricoes: formData.restricoes,
    objetivo: formData.objetivo,
    dificuldade: formData.dificuldade,
    tem_nutri_ou_dieta: formData.tem_nutri_ou_dieta,
    info_extra: formData.info_extra
});
```

**Depois:**
```typescript
const result = await updateUserData(user.id, {
    nome: formData.nome,
    telefone: formData.telefone,
    idade: formData.idade ? parseInt(formData.idade) : undefined,
    peso: formData.peso ? parseFloat(formData.peso.replace(',', '.')) : undefined,      // âœ… Correto
    altura: formData.altura ? parseFloat(formData.altura.replace(',', '.')) : undefined, // âœ… Correto
    problemas_de_saude: formData.problemas_de_saude,
    restricoes: formData.restricoes,
    objetivo: formData.objetivo,
    dificuldade: formData.dificuldade,
    tem_nutri_ou_dieta: formData.tem_nutri_ou_dieta,
    info_extra: formData.info_extra
});
```

---

## ğŸ“Š MudanÃ§as Principais

### 1. **Interface `AyraUser`**
- âŒ Removido: `peso_altura?: string`
- âœ… Adicionado: `peso?: number`
- âœ… Adicionado: `altura?: number`

### 2. **FunÃ§Ã£o `updateUserData`**
- âŒ Removido: `peso_altura: data.peso_altura`
- âœ… Adicionado: `peso: data.peso`
- âœ… Adicionado: `altura: data.altura`
- âœ… Adicionado: `nome: data.nome` (estava faltando)

### 3. **Chamada em `AnamnesePage`**
- âŒ Removido: `peso_altura: \`${formData.peso}kg / ${formData.altura}m\``
- âœ… Adicionado: `peso: parseFloat(formData.peso.replace(',', '.'))`
- âœ… Adicionado: `altura: parseFloat(formData.altura.replace(',', '.'))`

---

## ğŸ¯ ConversÃ£o de Tipos

### Peso:
```typescript
// Input do usuÃ¡rio: "85" ou "85,5"
formData.peso = "85,5"

// ConversÃ£o:
parseFloat(formData.peso.replace(',', '.'))
// Resultado: 85.5 (number)
```

### Altura:
```typescript
// Input do usuÃ¡rio: "1,75"
formData.altura = "1,75"

// ConversÃ£o:
parseFloat(formData.altura.replace(',', '.'))
// Resultado: 1.75 (number)
```

---

## ğŸ§ª Como Testar

### 1. Preencher FormulÃ¡rio:

1. VÃ¡ em `/perfil` â†’ "Dados Pessoais"
2. Preencha:
   - Nome: "Teste"
   - Telefone: "(11) 99999-9999"
   - Idade: "30"
   - Peso: "80" ou "80,5"
   - Altura: "1,75"
   - Problemas de saÃºde: "NÃ£o"
   - RestriÃ§Ãµes: "Nenhuma"
   - Objetivo: "Ganhar massa muscular"
   - Dificuldade: "Falta de tempo"
   - Acompanhamento: "NÃ£o tenho"
3. Clique em "Salvar Dados"

### 2. Verificar Sucesso:

âœ… **Toast:** "Dados salvos com sucesso!"
âœ… **Redirecionamento:** Para `/perfil` apÃ³s 1.5s
âœ… **localStorage:** Dados salvos localmente
âœ… **Supabase:** Dados salvos remotamente

### 3. Verificar no Supabase:

1. Abra Supabase Dashboard
2. VÃ¡ em "Table Editor" â†’ `ayra_cadastro`
3. Procure seu usuÃ¡rio (id = 1)
4. Verifique os campos:
   ```
   nome: "Teste"
   telefone: "(11) 99999-9999"
   idade: 30
   peso: 80.5
   altura: 1.75
   problemas_de_saude: "NÃ£o"
   restricoes: "Nenhuma"
   objetivo: "Ganhar massa muscular"
   dificuldade: "Falta de tempo"
   tem_nutri_ou_dieta: "NÃ£o tenho"
   updated_at: "2025-12-21T..."
   ```

---

## âœ… Checklist de CorreÃ§Ãµes

- [x] Interface `AyraUser` atualizada
- [x] Removido `peso_altura`
- [x] Adicionado `peso` e `altura` separados
- [x] FunÃ§Ã£o `updateUserData` corrigida
- [x] Adicionado `nome` no update
- [x] Chamada em `AnamnesePage` corrigida
- [x] ConversÃ£o de tipos implementada (string â†’ number)
- [x] Tratamento de vÃ­rgula para ponto
- [x] Campos opcionais com `undefined`

---

## ğŸ“ Arquivos Modificados

### 1. `src/lib/supabaseAuth.ts`
- âœ… Interface `AyraUser` atualizada
- âœ… FunÃ§Ã£o `updateUserData` corrigida
- âœ… Campos `peso` e `altura` separados

### 2. `src/pages/AnamnesePage.tsx`
- âœ… Chamada `updateUserData` corrigida
- âœ… ConversÃ£o de tipos implementada
- âœ… Passa `peso` e `altura` separados

---

## ğŸ¯ Resultado Final

### Antes:
- âŒ Erro 400: Column 'peso_altura' not found
- âŒ Dados nÃ£o salvavam no Supabase
- âŒ Toast de erro aparecia

### Depois:
- âœ… Dados salvam corretamente
- âœ… Campos `peso` e `altura` separados
- âœ… ConversÃ£o de tipos adequada
- âœ… Toast de sucesso
- âœ… Redirecionamento funciona
- âœ… SincronizaÃ§Ã£o localStorage + Supabase

---

**Erro corrigido e tudo funcionando! ğŸ‰**
