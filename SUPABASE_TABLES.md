# üìä Tabelas do Supabase - Projeto Ayra

## üìã Resumo das Tabelas Utilizadas

O projeto Ayra utiliza as seguintes tabelas no Supabase:

### ‚úÖ **Tabelas Principais (Em Uso)**

1. **`ayra_cadastro`** - Dados do usu√°rio e perfil
2. **`ayra_metas`** - Metas nutricionais e de lifestyle
3. **`ayra_diario_header`** - Cabe√ßalho do di√°rio di√°rio
4. **`ayra_diario_detalhes`** - Detalhes das refei√ß√µes
5. **`ayra_diario_lifestyle`** - Tracking de √°gua, sono, exerc√≠cio, humor

### üìä **Tabelas Admin (Para m√©tricas de neg√≥cio)**

6. **`ayra_subscriptions`** - Assinaturas e planos
7. **`ayra_conversion_events`** - Eventos de convers√£o (free ‚Üí premium)
8. **`ayra_churn_events`** - Eventos de cancelamento
9. **`ayra_user_activity`** - Atividade dos usu√°rios
10. **`ayra_daily_revenue`** - Receita di√°ria

### üìö **Tabelas de Biblioteca (Opcionais)**

11. **`tabela_taco`** - Biblioteca de alimentos (Tabela TACO - UNICAMP)
12. **`ayra_alimentos_favoritos`** - Alimentos favoritos do usu√°rio
13. **`ayra_templates_refeicao`** - Templates de refei√ß√µes salvas

---

## üîç Compara√ß√£o: Sua Tabela vs Schema do Projeto

### **Sua Tabela Atual:**
```sql
create table public.ayra_cadastro (
  id bigint generated by default as identity not null,
  nome text null,
  telefone text null,
  assinatura text null,
  idade numeric null,
  problemas_de_saude text null,
  restricoes text null,
  cadasatro_completo text null,  -- TYPO: "cadasatro"
  chat_id text null,
  objetivo text null,
  dificuldade text null,
  tem_nutri_ou_dieta text null,
  peso_altura text null,
  info_extra text null,
  constraint Ayra_pkey primary key (id)
)
```

### **Schema do Projeto (schema.sql):**
```sql
CREATE TABLE IF NOT EXISTS ayra_cadastro (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_usuario UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
    nome TEXT,
    telefone TEXT,
    idade TEXT,
    problemas_de_saude TEXT,
    restricoes TEXT,
    cadastro_completo VARCHAR(10) DEFAULT 'NAO',  -- 'SIM' ou 'NAO'
    objetivo TEXT,
    dificuldade TEXT,
    tem_nutri_ou_dieta TEXT,
    peso_altura TEXT,
    info_extra TEXT,
    plano VARCHAR(20) DEFAULT 'free',  -- 'free' ou 'premium'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
)
```

---

## ‚ö†Ô∏è **Diferen√ßas Importantes**

### 1. **Campo `id_usuario`** (CR√çTICO)
- ‚ùå **Sua tabela**: N√£o tem
- ‚úÖ **Projeto**: Tem `id_usuario UUID REFERENCES auth.users(id)`
- **Impacto**: Sem este campo, n√£o √© poss√≠vel vincular o cadastro ao usu√°rio autenticado do Supabase Auth

### 2. **Campo `assinatura`**
- ‚úÖ **Sua tabela**: Tem `assinatura text`
- ‚ùå **Projeto**: Usa `plano VARCHAR(20)` com valores 'free' ou 'premium'
- **Recomenda√ß√£o**: Padronizar para `plano`

### 3. **Campo `chat_id`**
- ‚úÖ **Sua tabela**: Tem `chat_id text`
- ‚ùå **Projeto**: N√£o tem
- **Uso**: Parece ser para integra√ß√£o com WhatsApp/n8n - **MANTER**

### 4. **Campo `cadastro_completo`**
- ‚ö†Ô∏è **Sua tabela**: `cadasatro_completo` (typo)
- ‚úÖ **Projeto**: `cadastro_completo VARCHAR(10) DEFAULT 'NAO'`
- **Recomenda√ß√£o**: Corrigir typo

### 5. **Campo `idade`**
- ‚ö†Ô∏è **Sua tabela**: `idade numeric`
- ‚úÖ **Projeto**: `idade TEXT`
- **Recomenda√ß√£o**: Usar TEXT para flexibilidade (ex: "25 anos")

### 6. **Campo `created_at`**
- ‚ùå **Sua tabela**: N√£o tem
- ‚úÖ **Projeto**: Tem timestamp de cria√ß√£o
- **Recomenda√ß√£o**: Adicionar para auditoria

---

## üîß **Script de Migra√ß√£o Recomendado**

Para adaptar sua tabela ao schema do projeto:

```sql
-- 1. Adicionar campos faltantes
ALTER TABLE public.ayra_cadastro
ADD COLUMN IF NOT EXISTS id_usuario UUID REFERENCES auth.users(id) ON DELETE CASCADE,
ADD COLUMN IF NOT EXISTS plano VARCHAR(20) DEFAULT 'free',
ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now());

-- 2. Renomear campo com typo (se necess√°rio)
ALTER TABLE public.ayra_cadastro
RENAME COLUMN cadasatro_completo TO cadastro_completo;

-- 3. Alterar tipo do campo idade (opcional)
ALTER TABLE public.ayra_cadastro
ALTER COLUMN idade TYPE TEXT;

-- 4. Adicionar constraint UNIQUE no id_usuario
ALTER TABLE public.ayra_cadastro
ADD CONSTRAINT ayra_cadastro_id_usuario_unique UNIQUE (id_usuario);

-- 5. Migrar dados de assinatura para plano (se necess√°rio)
UPDATE public.ayra_cadastro
SET plano = CASE
    WHEN LOWER(assinatura) LIKE '%premium%' THEN 'premium'
    WHEN LOWER(assinatura) LIKE '%pago%' THEN 'premium'
    ELSE 'free'
END
WHERE plano IS NULL;

-- 6. Habilitar RLS (Row Level Security)
ALTER TABLE public.ayra_cadastro ENABLE ROW LEVEL SECURITY;

-- 7. Criar pol√≠ticas RLS
CREATE POLICY "Users can view their own cadastro"
ON public.ayra_cadastro FOR SELECT
USING (auth.uid() = id_usuario);

CREATE POLICY "Users can update their own cadastro"
ON public.ayra_cadastro FOR UPDATE
USING (auth.uid() = id_usuario);

CREATE POLICY "Users can insert their own cadastro"
ON public.ayra_cadastro FOR INSERT
WITH CHECK (auth.uid() = id_usuario);
```

---

## üìù **Schema Completo Recomendado**

```sql
CREATE TABLE IF NOT EXISTS public.ayra_cadastro (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_usuario UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
    
    -- Dados pessoais
    nome TEXT,
    telefone TEXT,
    idade TEXT,
    
    -- Dados de sa√∫de
    problemas_de_saude TEXT,
    restricoes TEXT,
    peso_altura TEXT,
    
    -- Objetivos e contexto
    objetivo TEXT,
    dificuldade TEXT,
    tem_nutri_ou_dieta TEXT,
    info_extra TEXT,
    
    -- Status do cadastro
    cadastro_completo VARCHAR(10) DEFAULT 'NAO',  -- 'SIM' ou 'NAO'
    
    -- Plano e assinatura
    plano VARCHAR(20) DEFAULT 'free',  -- 'free' ou 'premium'
    assinatura TEXT,  -- MANTER para compatibilidade com seu sistema
    
    -- Integra√ß√£o externa
    chat_id TEXT,  -- MANTER para integra√ß√£o WhatsApp/n8n
    
    -- Auditoria
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- √çndices para performance
CREATE INDEX IF NOT EXISTS idx_ayra_cadastro_id_usuario ON public.ayra_cadastro(id_usuario);
CREATE INDEX IF NOT EXISTS idx_ayra_cadastro_plano ON public.ayra_cadastro(plano);
CREATE INDEX IF NOT EXISTS idx_ayra_cadastro_chat_id ON public.ayra_cadastro(chat_id);
```

---

## üîÑ **Como o Projeto Usa as Tabelas**

### **1. AuthContext.tsx**
```typescript
// Busca perfil do usu√°rio
const { data } = await supabase
    .from('ayra_cadastro')
    .select('*')
    .eq('id_usuario', user.id)
    .single();
```

### **2. AnamnesePage.tsx**
```typescript
// Salva/atualiza dados da anamnese
await supabase
    .from('ayra_cadastro')
    .upsert({
        id_usuario: user?.id,
        nome: formData.nome,
        idade: formData.idade,
        // ...
    }, { onConflict: 'id_usuario' });
```

### **3. Register.tsx**
```typescript
// Salva refei√ß√µes
await supabase
    .from('ayra_diario_header')
    .upsert({ id_usuario: user?.id, data_consumo: today });

await supabase
    .from('ayra_diario_detalhes')
    .insert({ id_diario_header, tipo_refeicao, alimento_descricao });

// Salva lifestyle
await supabase
    .from('ayra_diario_lifestyle')
    .upsert({ id_usuario: user?.id, agua_ml, exercicio_feito, horas_sono });
```

### **4. MetasPage.tsx**
```typescript
// Busca e salva metas
await supabase
    .from('ayra_metas')
    .select('*')
    .eq('id_usuario', user?.id);
```

---

## ‚úÖ **Checklist de Configura√ß√£o do Supabase**

### **Passo 1: Criar/Atualizar Tabela `ayra_cadastro`**
- [ ] Executar script de migra√ß√£o acima
- [ ] Verificar se `id_usuario` est√° vinculado a `auth.users`
- [ ] Confirmar que RLS est√° habilitado
- [ ] Testar pol√≠ticas de seguran√ßa

### **Passo 2: Criar Tabelas Adicionais**
- [ ] Executar `schema.sql` completo
- [ ] Verificar cria√ß√£o de:
  - [ ] `ayra_metas`
  - [ ] `ayra_diario_header`
  - [ ] `ayra_diario_detalhes`
  - [ ] `ayra_diario_lifestyle`

### **Passo 3: Tabelas Admin (Opcional)**
- [ ] Executar `schema_admin.sql` se quiser m√©tricas de neg√≥cio
- [ ] Criar:
  - [ ] `ayra_subscriptions`
  - [ ] `ayra_conversion_events`
  - [ ] `ayra_churn_events`
  - [ ] `ayra_user_activity`
  - [ ] `ayra_daily_revenue`

### **Passo 4: Biblioteca de Alimentos (Opcional)**
- [ ] Criar `tabela_taco` se quiser biblioteca de alimentos
- [ ] Importar dados da Tabela TACO (j√° tem alguns no schema.sql)

### **Passo 5: Configurar Autentica√ß√£o**
- [ ] Habilitar Email Auth no Supabase
- [ ] Configurar URLs de redirecionamento
- [ ] Testar login/registro

---

## üö® **Campos Cr√≠ticos para Funcionamento**

### **OBRIGAT√ìRIOS:**
1. ‚úÖ `id_usuario` - Vincula ao auth.users
2. ‚úÖ `plano` - Define se √© free ou premium (usado em toda aplica√ß√£o)
3. ‚úÖ `nome` - Exibido no perfil e chat

### **RECOMENDADOS:**
4. ‚úÖ `restricoes` - Usado para alertas de alergia
5. ‚úÖ `objetivo` - Personaliza mensagens da IA
6. ‚úÖ `cadastro_completo` - Controla se mostra anamnese

### **OPCIONAIS (Seu sistema):**
7. ‚úÖ `chat_id` - Para integra√ß√£o WhatsApp/n8n
8. ‚úÖ `assinatura` - Se voc√™ tem sistema pr√≥prio de assinatura

---

## üìû **Pr√≥ximos Passos**

1. **Decidir**: Voc√™ quer adaptar sua tabela ou criar do zero?
2. **Executar**: Script de migra√ß√£o ou schema.sql completo
3. **Testar**: Login e cadastro no app
4. **Configurar**: Vari√°veis de ambiente na Vercel

---

**Precisa de ajuda para:**
- [ ] Executar a migra√ß√£o?
- [ ] Adaptar o c√≥digo para sua estrutura atual?
- [ ] Criar as outras tabelas?
- [ ] Configurar RLS e pol√≠ticas de seguran√ßa?

Me avise e eu te ajudo! üöÄ
